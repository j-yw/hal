# Ralph Progress Log

## Codebase Patterns
- Type packages use simple Go structs with JSON tags for serialization
- Constants for enum-like values are defined as package-level `const` blocks
- Package organization follows internal/{domain}/types.go pattern
- Config loading uses gopkg.in/yaml.v3 with default fallback pattern
- Use DefaultXXX() functions to provide sensible defaults when config is missing

---

## 2026-01-30 - T-001
- Implemented compound types package at internal/compound/types.go
- Created AnalysisResult struct with PriorityItem, Description, Rationale, AcceptanceCriteria, EstimatedTasks, BranchName
- Created PipelineState struct with Step, BranchName, ReportPath, PRDPath, StartedAt, Analysis
- Added Step constants: StepAnalyze, StepBranch, StepPRD, StepExplode, StepLoop, StepPR
- Files changed: internal/compound/types.go (new)
- **Learnings for future iterations:**
  - Follow existing type patterns from internal/engine/prd.go
  - Use `omitempty` JSON tag for optional pointer fields
  - Constants provide type safety for step values
---

## 2026-01-30 - T-002
- Created compound config loader at internal/compound/config.go
- Created AutoConfig struct with ReportsDir, BranchPrefix, QualityChecks, MaxIterations
- Implemented LoadConfig(dir string) that reads from .goralph/config.yaml
- Added DefaultAutoConfig() with sensible defaults: reportsDir: .goralph/reports, branchPrefix: compound/, maxIterations: 25
- Added gopkg.in/yaml.v3 dependency
- Files changed: internal/compound/config.go (new), go.mod, go.sum
- **Learnings for future iterations:**
  - Use yaml.v3 for YAML parsing in Go
  - Merge pattern: load defaults first, then override with config values
  - Config struct can contain nested sections (Config.Auto for auto-specific settings)
---

## 2026-01-30 - T-003
- Created default config.yaml template at internal/template/config.yaml
- Template includes all settings: engine, maxIterations, retryDelay, maxRetries
- Template includes auto section: reportsDir, branchPrefix, qualityChecks, maxIterations
- All settings have descriptive comments explaining their purpose and defaults
- Embedded config.yaml in template.go using //go:embed
- Added config.yaml to DefaultFiles() map so init command will install it
- Files changed: internal/template/config.yaml (new), internal/template/template.go
- **Learnings for future iterations:**
  - Template files use //go:embed directive with matching variable names (DefaultConfig for config.yaml)
  - DefaultFiles() map controls which files goralph init creates
  - YAML comments with section separators improve readability of config files
---

## 2026-01-30 - T-004
- Updated init command to create config.yaml and reports directory
- goralph init now creates .goralph/config.yaml if it doesn't exist (already handled by DefaultFiles() from T-003)
- goralph init now creates .goralph/reports/ directory with .gitkeep
- Updated command Long description to document config.yaml and reports/ directory
- Files changed: cmd/init.go
- **Learnings for future iterations:**
  - Init command uses os.MkdirAll for idempotent directory creation
  - .gitkeep files ensure empty directories are tracked by git
  - DefaultFiles() already handles file creation/preservation logic - just add to the map
---

## 2026-01-30 - T-005
- Created autospec skill for autonomous PRD generation at internal/skills/autospec/SKILL.md
- Skill self-clarifies using analysis context (no user questions) for auto pipeline use
- Uses T-XXX task IDs (not US-XXX) for compound engineering format
- Includes boolean acceptance criteria patterns for autonomous verification
- Updated embed.go to include autospec in SkillContent map and SkillNames slice
- Files changed: internal/skills/autospec/SKILL.md (new), internal/skills/embed.go
- **Learnings for future iterations:**
  - Skills use //go:embed with matching variable name convention (e.g., autospecSkillContent)
  - SkillContent map and SkillNames slice must both be updated when adding new skills
  - Skill frontmatter uses YAML format with name and description fields
  - Autonomous skills should avoid interactive elements like AskUserQuestion
---

## 2026-01-30 - T-006
- Created explode skill for task breakdown at internal/skills/explode/SKILL.md
- Skill breaks down PRDs into 8-15 granular tasks for autonomous execution
- Uses T-XXX task IDs and outputs to .goralph/prd.json in userStories format
- Documents task sizing (one iteration rule), dependency ordering, and boolean acceptance criteria
- Updated embed.go to include explode in SkillContent map and SkillNames slice
- Files changed: internal/skills/explode/SKILL.md (new), internal/skills/embed.go
- **Learnings for future iterations:**
  - Skill pattern consistent: YAML frontmatter + markdown body + examples
  - Task count 8-15 is calibrated for context window limits
  - Standard ordering: investigation -> schema -> backend -> UI -> verification
  - Use userStories field (not tasks) for backward compatibility with existing Ralph loop
---

## 2026-01-30 - T-007
- Verified T-007 acceptance criteria - all work already completed during T-005 and T-006
- embed.go already has //go:embed for autospec/SKILL.md and explode/SKILL.md
- SkillContent map already contains autospec and explode entries
- SkillNames slice already contains "autospec" and "explode"
- Typecheck passed (go vet ./...)
- Tests passed (go test ./internal/skills/... - no test files, no failures)
- Files changed: .goralph/prd.json (marked T-007 as passes: true)
- **Learnings for future iterations:**
  - When implementing skills (T-005, T-006), embed.go updates are best done in the same PR
  - Check if earlier stories already completed dependent work before implementing
- Engine interface has Prompt() method for single-shot prompts (returns string, error)

---

## 2026-01-30 - T-008
- Added Tasks field to PRD struct in internal/engine/prd.go with json:"tasks,omitempty" tag
- Updated CurrentStory() to check UserStories first, then Tasks (backward compatible)
- Updated Progress() to count both UserStories and Tasks
- Updated FindStoryByID() to search both UserStories and Tasks
- Created comprehensive test suite at internal/engine/prd_test.go (13 test cases)
- All tests pass with both userStories and tasks formats
- Files changed: internal/engine/prd.go, internal/engine/prd_test.go (new)
- **Learnings for future iterations:**
  - PRD struct now supports dual-format: userStories (backward compatible) and tasks (new format)
  - When adding new fields that may be empty, use omitempty JSON tag
  - UserStories takes precedence over Tasks in CurrentStory() for backward compatibility
  - Always update related methods (FindStoryByID) when adding new data sources
---

## 2026-01-30 - T-009
- Created report finder and analyzer at internal/compound/analyze.go
- Implemented FindLatestReport(reportsDir string) - returns most recently modified file
- Implemented FindRecentPRDs(dir string, days int) - finds prd-*.md files created in last N days
- Implemented AnalyzeReport(ctx, eng, reportPath, recentPRDs) - uses engine.Prompt() to analyze reports
- Analysis prompt instructs engine to return JSON with priorityItem, description, rationale, acceptanceCriteria, estimatedTasks, branchName
- parseAnalysisResponse extracts JSON from response (handles markdown code fences)
- Files changed: internal/compound/analyze.go (new)
- **Learnings for future iterations:**
  - Use engine.Prompt() for single-shot prompts that return text
  - When parsing JSON from LLM output, search for { and } to handle code fences
  - FindLatestReport skips hidden files and .gitkeep
  - Recent PRDs help avoid duplicating work already in progress
---

## 2026-01-30 - T-010
- Created analyze command at cmd/analyze.go
- Accepts optional [report-path] positional argument to analyze specific file
- --reports-dir flag overrides config.yaml reportsDir setting
- --output flag supports "text" (default) and "json" formats
- --engine flag allows selecting engine (defaults to claude)
- Text output shows formatted box with priority item, description, rationale, acceptance criteria, estimated tasks, suggested branch
- JSON output returns AnalysisResult struct directly
- Handles no reports gracefully: exits with code 0 and shows informational message
- Uses compound.LoadConfig, compound.FindLatestReport, compound.AnalyzeReport, compound.FindRecentPRDs
- Files changed: cmd/analyze.go (new)
- **Learnings for future iterations:**
  - Cobra commands follow pattern: Use, Short, Long, Args, RunE
  - Use engine.NewDisplay(os.Stdout) for display feedback
  - LoadConfig returns defaults when config file is missing
  - Return nil (not error) for informational exits like "no reports found"
---

## 2026-01-30 - T-011
- Created git helper functions at internal/compound/git.go
- Implemented CreateBranch(branchName string) - creates and checks out new branch from HEAD
- Implemented CurrentBranch() - returns current branch name using git branch --show-current
- Implemented PushBranch(branchName string) - pushes with -u flag to set upstream
- Implemented CreatePR(title, body, base string) - uses gh pr create --draft
- All functions return descriptive error messages with stderr output on failure
- Files changed: internal/compound/git.go (new)
- **Learnings for future iterations:**
  - Use bytes.Buffer for capturing stdout/stderr from exec.Command
  - Git commands use git CLI directly, PR creation uses gh CLI
  - Always trim whitespace from command output (strings.TrimSpace)
  - Handle empty output cases (e.g., detached HEAD state)
---

## 2026-01-30 - T-012
- Created explode command at cmd/explode.go
- Accepts [prd-path] positional argument (required)
- --branch flag sets branch name in output prd.json
- --engine flag allows selecting engine (defaults to claude)
- Uses engine.StreamPrompt() with explode skill prompt for visual feedback
- Outputs to .goralph/prd.json
- Shows progress with display.ShowCommandHeader and ShowCommandSuccess
- Handles both engine-written files and JSON from text response
- Includes helper functions for JSON extraction from LLM output
- Files changed: cmd/explode.go (new)
- **Learnings for future iterations:**
  - Follow convert.go pattern: check if engine wrote file directly, fallback to text parsing
  - Use time.Time comparison to detect if engine wrote output file
  - Extract branch name from prd-*.md filename pattern
  - StreamPrompt provides visual feedback during long operations
---

## 2026-01-30 - T-013
- Created pipeline state management at internal/compound/pipeline.go
- Created Pipeline struct with config *AutoConfig, engine engine.Engine, display *engine.Display, dir string
- Implemented NewPipeline() constructor function
- Implemented loadState() *PipelineState that reads from .goralph/auto-state.json
- Implemented saveState(state *PipelineState) error with atomic write (temp file + rename)
- Implemented clearState() error that removes state file on completion
- Added HasState() helper method to check if resumable state exists
- Files changed: internal/compound/pipeline.go (new)
- **Learnings for future iterations:**
  - Use atomic write pattern (write to .tmp, then rename) for state files
  - loadState returns nil instead of error when file doesn't exist - simplifies resume logic
  - clearState handles non-existent file gracefully (returns nil)
  - State file path is .goralph/auto-state.json
---

