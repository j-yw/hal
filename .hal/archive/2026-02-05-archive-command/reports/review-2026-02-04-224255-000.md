# Review Report: hal/archive-command

Date: 2026-02-04 22:42

## Summary

Review skill applied to analyze the hal/archive-command work that delivered a full archive command suite and shared archive package. The session centralized create/list/restore and branch parsing in internal/archive, added CLI commands and tests, updated help text, and verified builds and checks.

## What Was Built

```
b8f4849 chore: apply gofmt formatting fixes
786efea feat: US-010 - End-to-end verification
79c68c6 feat: US-009 - Update root command help text
93adad8 feat: US-008 - Refactor convert.go to use shared archive package
57b5f73 feat: US-007 - Create Cobra commands for archive suite
2d22de6 feat: US-006 - Unit tests for archive package
2306f34 feat: US-005 - Create archive.Restore function
0935863 feat: US-004 - Create archive.List and archive.FormatList functions
8c9714f feat: US-002 - Create archive.Create function
8c455c6 feat: US-001 - Add AutoStateFile constant to template package

```

## Issues Encountered

- Archive names could collide when the same feature is archived multiple times; resolved by adding numeric suffixes like -2, -3 during Create.
- Restore needed to handle both flat files and subdirectories like reports/; resolved by implementing a recursive restoreDir helper.
- Reports globbing could include reports/.gitkeep and filepath.Glob can return nil; resolved by skipping .gitkeep and safely iterating over nil slices.

## Tech Debt Introduced

- Archive moves rely on os.Rename only; there is no copy-and-remove fallback for cross-filesystem moves, which could fail if .hal/ lives on another device.
- Archive list parsing assumes a YYYY-MM-DD prefix and silently skips malformed names; add validation or explicit warnings if users create custom archive names.

## Recommendations for Next Priorities

1. Add a copy-and-remove fallback when archive.Create/Restore hits cross-device rename errors and cover it with tests.
2. Add CLI-level tests for cmd/archive.go, including prompt defaulting, --verbose formatting, and restore error paths.
3. Document archive naming and behavior in README or agent-os docs and mention the auto-archive-on-restore behavior.
4. Consider a machine-readable output option (e.g., JSON) for archive list to support scripting.

## Patterns Discovered

These patterns have been added to AGENTS.md:

- Keep file-name constants in internal/template (e.g., template.AutoStateFile) and reference them from other packages; use a package-level var when a constant depends on template values.
- All archiving behavior lives in internal/archive; other packages should call archive.Create/List/Restore and reuse archive.FeatureFromBranch instead of duplicating parsing.
- Update the featureStateFiles slice in internal/archive/archive.go whenever new state files are introduced; it is the single list that drives what gets archived.
- Archive directories are named YYYY-MM-DD-feature and list parsing expects the date in name[:10]; keep this naming consistent for reliable listing.
- Archive CLI commands follow the Cobra parent-subcommand pattern and prompt for missing names using bufio.NewReader(os.Stdin) with a default derived from prd.json branchName.
