# Hal Progress

## Codebase Patterns
- progress.txt is the single source of truth for both manual and auto workflows (consolidated from separate files)
- When removing constants, also update all usages in tests to maintain compilation
- Archive feature state files are defined in internal/archive/archive.go featureStateFiles slice

---

## 2026-02-05 - US-001: Remove AutoProgressFile constant from template package
- Removed AutoProgressFile constant from internal/template/template.go
- Removed AutoProgressFile from DefaultFiles() map (hal init no longer creates auto-progress.txt)
- Updated internal/archive/archive.go to remove AutoProgressFile from featureStateFiles
- Updated internal/compound/pipeline.go to use ProgressFile instead of AutoProgressFile
- Updated internal/archive/archive_test.go to use ProgressFile instead of AutoProgressFile
- **Learnings for future iterations:**
  - Removing a constant requires updating all usages including test files
  - The featureStateFiles slice defines which files are archived - update it when removing state files
  - Pipeline uses ProgressFile for loop config, not a separate auto file
---

## 2026-02-05 - US-003: Add migration logic for existing auto-progress.txt
- Added migrateAutoProgress() method to internal/compound/pipeline.go
- Migration runs before progress file initialization in runLoopStep()
- If auto-progress.txt exists and has content, it is merged into progress.txt:
  - If progress.txt is empty/default: auto-progress content replaces it
  - If both have content: auto-progress content is appended with separator
- Legacy auto-progress.txt is deleted after successful migration
- Migration is logged to display output
- **Learnings for future iterations:**
  - Migration logic should handle edge cases: empty files, default content, missing files
  - Use os.IsNotExist() to distinguish "file not found" from other read errors
  - Template.DefaultProgress can be used to detect "unchanged default" state
---

## 2026-02-05 - US-004: Fix hardcoded path in hal review context gathering
- Added template import to internal/compound/review.go
- Changed hardcoded filepath.Join(dir, ".hal", "progress.txt") to filepath.Join(dir, template.HalDir, template.ProgressFile)
- **Learnings for future iterations:**
  - Use template constants for all .hal directory paths to ensure consistency
  - Template package provides HalDir, ProgressFile, PRDFile, etc. constants
---

## 2026-02-05 - US-005: Add JSON PRD reading to hal review context
- Added PRDJSONContent and AutoPRDContent fields to reviewContext struct
- Read prd.json and auto-prd.json content after markdown PRD reading
- Updated hasAnyContext() to include PRDJSONContent and AutoPRDContent
- **Learnings for future iterations:**
  - JSON PRDs contain task completion status (passes field) that markdown PRDs don't
  - Both prd.json (manual flow) and auto-prd.json (auto flow) should be checked
---

## 2026-02-05 - US-006: Include JSON PRD content in review prompt
- Updated buildReviewPrompt() to include PRDJSONContent and AutoPRDContent sections
- Truncate JSON PRD content to 5000 chars each
- Updated dry-run output to show JSON PRD context sizes
- **Learnings for future iterations:**
  - JSON PRDs provide task completion percentages for accurate progress reporting
  - Keep truncation limits reasonable to fit within model context windows
---

## 2026-02-05 - US-008: Update archive command help text
- Removed auto-progress.txt from the archived files list in cmd/archive.go help text
- **Learnings for future iterations:**
  - Keep CLI help text synchronized with actual behavior
  - Help text is in cobra.Command Long field
---
