# Hal Progress Log

## Codebase Patterns
- Type packages use simple Go structs with JSON tags for serialization
- Constants for enum-like values are defined as package-level `const` blocks
- Package organization follows internal/{domain}/types.go pattern
- Config loading uses gopkg.in/yaml.v3 with default fallback pattern
- Use DefaultXXX() functions to provide sensible defaults when config is missing
- Integration tests use `//go:build integration` tag and skip when CLI unavailable
- Use mockEngine for unit testing engine.Engine interface without LLM calls
- State machine loops must have terminal state to avoid infinite loops
- Archive package (`internal/archive`) handles all file archiving/restoring — use `archive.Create`, `archive.List`, `archive.Restore`
- `archive.FeatureFromBranch` is the canonical branch-name parser — don't duplicate in other packages

---

## 2026-02-04 - US-001
- Added `AutoStateFile = "auto-state.json"` constant to `internal/template/template.go`
- Updated `internal/compound/pipeline.go` to use `template.AutoStateFile` instead of local `const stateFileName` literal
- Files changed: `internal/template/template.go`, `internal/compound/pipeline.go`
- **Learnings for future iterations:**
  - The template package is the canonical location for all file name constants (PRDFile, AutoPRDFile, etc.)
  - `pipeline.go` uses a package-level `var` (not `const`) for `stateFileName` since it references the template constant
  - `go fmt` may adjust alignment in const blocks — run `make fmt` after editing
---

## 2026-02-04 - US-002
- Created `internal/archive/archive.go` with `Create` function
- Moves prd.json, auto-prd.json, progress.txt, auto-progress.txt, auto-state.json, prd-*.md, and reports/*.md (excluding .gitkeep)
- Protects config.yaml, prompt.md, skills/, archive/, rules/
- Collision handling appends -2, -3, etc.
- Also added `FeatureFromBranch` and helper utilities
- Files changed: `internal/archive/archive.go` (new)
- **Learnings for future iterations:**
  - Archive package uses `os.Rename` for moves — works within same filesystem
  - `filepath.Glob` returns nil (not error) when no matches, safe to range over directly
  - The `featureStateFiles` slice defines what gets archived — update if new state files are added
---

## 2026-02-04 - US-003
- `FeatureFromBranch` was already implemented as part of US-002 in `internal/archive/archive.go`
- No additional changes needed
---

## 2026-02-04 - US-004
- Added `ArchiveInfo` struct, `List`, and `FormatList` functions to `internal/archive/archive.go`
- List scans archive directories, parses date/feature from name, loads PRD stats
- FormatList supports verbose mode with branch name and full path columns
- Uses `engine.PRD.Progress()` for completion stats
- Files changed: `internal/archive/archive.go`
- **Learnings for future iterations:**
  - `engine.PRD` has a `Progress()` method returning `(completed, total)` — reuse it for stats
  - Archive dir names follow `YYYY-MM-DD-feature` convention — parse with `name[:10]` for date
---

## 2026-02-04 - US-005
- Added `Restore` function and `restoreDir` helper to `internal/archive/archive.go`
- Auto-archives current state before restoring if prd.json or auto-prd.json exists
- Handles directory entries (like reports/) via recursive restoreDir helper
- Removes archive directory after successful restore
- Files changed: `internal/archive/archive.go`
- **Learnings for future iterations:**
  - Restore needs to handle both flat files and subdirectories (reports/)
  - Auto-archive name uses "auto-saved" to distinguish from user-created archives
---

## 2026-02-04 - US-006
- Created `internal/archive/archive_test.go` with comprehensive table-driven tests
- TestCreate: 6 cases + TestCreate_NameCollisionSuffix (-2, -3 suffix)
- TestList: 3 cases (multiple archives with stats, empty, malformed)
- TestRestore: 3 cases (success, auto-archives first, non-existent)
- TestFeatureFromBranch: 4 cases
- All tests use t.TempDir(), no external dependencies
- Files changed: `internal/archive/archive_test.go` (new)
---

## 2026-02-04 - US-007
- Created `cmd/archive.go` with three Cobra commands: `archive`, `archive list`, `archive restore`
- Parent command uses `--name` flag or interactive prompt with default from prd.json branchName
- List command uses `--verbose` flag for detailed output
- Restore command requires exactly 1 arg via `cobra.ExactArgs(1)`
- All commands check `.hal/` existence and suggest `hal init`
- Files changed: `cmd/archive.go` (new)
- **Learnings for future iterations:**
  - Interactive prompts use `bufio.NewReader(os.Stdin)` pattern from generate.go
  - Cobra parent-subcommand pattern: `parentCmd.AddCommand(childCmd)` then `rootCmd.AddCommand(parentCmd)` in init()
---

## 2026-02-04 - US-008
- Refactored `archiveExistingPRD` in `internal/prd/convert.go` to delegate to `archive.Create(dir, "", io.Discard)`
- Replaced `extractFeatureFromBranch` with `archive.FeatureFromBranch`
- Removed `extractFeatureFromBranch` function (now in archive package)
- Same-feature skip check remains in convert.go
- `extractFeatureName` helper remains local (parses markdown filenames)
- Removed unused `template` import
- Files changed: `internal/prd/convert.go`
---

## 2026-02-04 - US-009
- Updated `cmd/root.go` Long help text to include `archive` in Commands listing and Workflow section
- Files changed: `cmd/root.go`
---

## 2026-02-04 - US-010
- End-to-end verification: `make build`, `make test`, `make vet`, `make fmt` all pass
- All three `--help` commands print correct usage
- All 10 user stories complete and passing
---

