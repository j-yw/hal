{
  "project": "hal",
  "branchName": "compound/migration-cleanup-tests",
  "description": "Add comprehensive unit tests for migrateAutoProgress in internal/compound/pipeline.go and hal cleanup command in cmd/cleanup.go to lock in correctness of progress file consolidation.",
  "userStories": [
    {
      "id": "T-001",
      "title": "Extract migrateAutoProgress for testability",
      "description": "As a developer, I need the migrateAutoProgress function to be testable in isolation so that unit tests can verify its behavior without needing a full Pipeline instance.",
      "acceptanceCriteria": [
        "Create internal/compound/migrate.go with standalone MigrateAutoProgress(dir string, display DisplayWriter) error function",
        "Define DisplayWriter interface with ShowInfo(format string, args ...any) method in migrate.go",
        "Refactor Pipeline.migrateAutoProgress() to call MigrateAutoProgress(p.dir, p.display)",
        "Existing functionality remains unchanged (no behavioral changes)",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-002",
      "title": "Test merge when both files have content",
      "description": "As a developer, I need a test that verifies when both auto-progress.txt and progress.txt have meaningful content, they are merged with a separator.",
      "acceptanceCriteria": [
        "Create internal/compound/migrate_test.go with TestMigrateAutoProgress_MergeBothHaveContent",
        "Test creates progress.txt with 'Existing progress notes' content",
        "Test creates auto-progress.txt with 'Auto progress notes' content",
        "After migration, progress.txt contains original content + '---' + 'Migrated from auto-progress.txt' header + auto-progress content",
        "auto-progress.txt is deleted after merge",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-003",
      "title": "Test replacement when progress.txt is empty",
      "description": "As a developer, I need a test that verifies when progress.txt is empty, its content is replaced entirely with auto-progress.txt content.",
      "acceptanceCriteria": [
        "Add TestMigrateAutoProgress_ReplaceWhenEmpty to migrate_test.go",
        "Test creates empty progress.txt file",
        "Test creates auto-progress.txt with 'Auto progress content' content",
        "After migration, progress.txt contains exactly the auto-progress content (no separator)",
        "auto-progress.txt is deleted after replacement",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-004",
      "title": "Test replacement when progress.txt has default content",
      "description": "As a developer, I need a test that verifies when progress.txt contains only the default template, it is replaced entirely.",
      "acceptanceCriteria": [
        "Add TestMigrateAutoProgress_ReplaceWhenDefault to migrate_test.go",
        "Test creates progress.txt with template.DefaultProgress content",
        "Test creates auto-progress.txt with meaningful content",
        "After migration, progress.txt contains exactly the auto-progress content (no separator)",
        "auto-progress.txt is deleted after replacement",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-005",
      "title": "Test no-op when auto-progress.txt does not exist",
      "description": "As a developer, I need a test that verifies migration does nothing when there is no legacy file to migrate.",
      "acceptanceCriteria": [
        "Add TestMigrateAutoProgress_NoOpWhenNoLegacyFile to migrate_test.go",
        "Test creates only progress.txt with 'Existing content' (no auto-progress.txt)",
        "After migration, progress.txt is unchanged",
        "Function returns nil (no error)",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-006",
      "title": "Test empty auto-progress.txt is removed without merging",
      "description": "As a developer, I need a test that verifies an empty or default-only auto-progress.txt is simply removed without merging.",
      "acceptanceCriteria": [
        "Add TestMigrateAutoProgress_RemoveEmptyLegacy to migrate_test.go",
        "Test creates progress.txt with 'Existing content'",
        "Test creates empty auto-progress.txt",
        "After migration, progress.txt is unchanged",
        "auto-progress.txt is deleted",
        "Add subtest for auto-progress.txt containing only template.DefaultProgress",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-007",
      "title": "Extract runCleanup for testability",
      "description": "As a developer, I need the cleanup logic extracted into a testable function that accepts an output writer.",
      "acceptanceCriteria": [
        "Create runCleanupFn(halDir string, dryRun bool, w io.Writer) error function in cmd/cleanup.go",
        "Refactor runCleanup Cobra handler to call runCleanupFn(template.HalDir, cleanupDryRun, os.Stdout)",
        "All fmt.Printf calls in runCleanupFn use fmt.Fprintf(w, ...) instead",
        "Existing functionality remains unchanged (no behavioral changes)",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-008",
      "title": "Test cleanup dry-run output",
      "description": "As a developer, I need a test that verifies --dry-run shows what would be deleted without actually deleting files.",
      "acceptanceCriteria": [
        "Create cmd/cleanup_test.go with TestRunCleanupFn_DryRun",
        "Test creates .hal/auto-progress.txt file in temp directory",
        "Run runCleanupFn with dryRun=true and bytes.Buffer for output",
        "Output contains 'Would remove:' and the file path",
        "File still exists after dry-run",
        "Output contains summary of how many files would be removed",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-009",
      "title": "Test cleanup actual deletion",
      "description": "As a developer, I need a test that verifies cleanup actually deletes orphaned files when not in dry-run mode.",
      "acceptanceCriteria": [
        "Add TestRunCleanupFn_ActualDeletion to cleanup_test.go",
        "Test creates .hal/auto-progress.txt file in temp directory",
        "Run runCleanupFn with dryRun=false and bytes.Buffer for output",
        "Output contains 'Removed:' and the file path",
        "File no longer exists after cleanup (os.Stat returns os.IsNotExist)",
        "Output contains summary of how many files were removed",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "T-010",
      "title": "Test cleanup when no orphaned files exist",
      "description": "As a developer, I need a test that verifies cleanup handles the case when there are no orphaned files gracefully.",
      "acceptanceCriteria": [
        "Add TestRunCleanupFn_NoOrphanedFiles to cleanup_test.go",
        "Test creates .hal/ directory with no orphaned files (only config.yaml)",
        "Run runCleanupFn with dryRun=false and bytes.Buffer for output",
        "Output contains 'No orphaned files found.'",
        "Function returns nil (no error)",
        "Typecheck passes (go vet ./...)"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    }
  ]
}