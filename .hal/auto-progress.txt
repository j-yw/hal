# Hal Progress Log

## Codebase Patterns

- LoadConfig uses rawAutoConfig with pointer fields (*string, *int) to distinguish missing YAML keys from explicit empty values. nil means "not set" (use default), non-nil means "explicitly set" (pass through to Validate).
- AutoConfig.Validate() checks: ReportsDir non-empty, BranchPrefix non-empty, MaxIterations > 0.

---

## 2026-02-05 - T-001
- Added Validate() error method to AutoConfig in internal/compound/config.go
- Added fmt import for error formatting
- LoadConfig now calls Validate() on merged config before returning
- Files changed: internal/compound/config.go
- **Learnings for future iterations:**
  - The merge logic in LoadConfig uses != "" guards, meaning explicitly empty YAML values fall back to defaults rather than being passed to Validate. Only maxIterations can fail validation through YAML (e.g., -1) because it merges on > 0.
  - Validate error messages use exact format "auto.<field> must not be empty" / "must be greater than 0" — tests should match these strings.
---

## 2026-02-05 - T-002
- Created internal/compound/config_test.go with TestDefaultAutoConfig
- Verifies ReportsDir, BranchPrefix, MaxIterations, and QualityChecks defaults
- Files changed: internal/compound/config_test.go (new)
- **Learnings for future iterations:**
  - Tests in internal/compound/ don't need integration build tags — they run as standard unit tests.
  - Existing test patterns in this package use table-driven tests with t.Run subtests (see review_test.go).
---

## 2026-02-05 - T-003
- Added TestLoadConfig_MissingFile with two subtests: non-existent directory and empty directory
- Added assertConfigMatchesDefaults helper for reuse across LoadConfig tests
- Files changed: internal/compound/config_test.go
- **Learnings for future iterations:**
  - LoadConfig expects .hal/config.yaml relative to the dir argument, so test with t.TempDir() as the dir.
  - Use assertConfigMatchesDefaults helper when comparing full config to defaults.
---

## 2026-02-05 - T-004
- Added TestLoadConfig_ValidYAML with table-driven tests: full config, partial config, empty auto section
- Files changed: internal/compound/config_test.go
- **Learnings for future iterations:**
  - YAML with `auto:\n` (empty section) parses fine and all fields get defaults from merge logic.
  - Test pattern: create t.TempDir(), mkdir .hal, write config.yaml, call LoadConfig(dir).
---

## 2026-02-05 - T-005
- Added TestLoadConfig_InvalidYAML with 4 test cases: invalid YAML, negative maxIterations, empty reportsDir, empty branchPrefix
- Changed Config.Auto from AutoConfig to rawAutoConfig with pointer fields to distinguish missing vs explicitly-empty values
- Files changed: internal/compound/config.go, internal/compound/config_test.go
- **Learnings for future iterations:**
  - To detect explicitly-set empty strings in YAML, use pointer fields (*string) in the unmarshal target struct. nil = key absent, non-nil = key present.
  - The rawAutoConfig struct is internal to the config package — AutoConfig remains the public type.
---

## 2026-02-05 - T-006
- Created internal/compound/analyze_test.go with TestFindLatestReport (5 subtests)
- Tests: single file, multiple files with mtime control, empty dir, non-existent dir, hidden files skipped
- Files changed: internal/compound/analyze_test.go (new)
- **Learnings for future iterations:**
  - FindLatestReport skips hidden files (. prefix) and directories. Only non-hidden regular files are considered.
  - Use os.Chtimes to control file modification times in tests for deterministic ordering.
---

## 2026-02-05 - T-007
- Added TestFindRecentPRDs with 4 subtests in analyze_test.go
- Tests: recent files returned, old files excluded, nil for missing .hal, only prd-*.md matched
- Files changed: internal/compound/analyze_test.go
- **Learnings for future iterations:**
  - FindRecentPRDs searches dir/.hal/ for prd-*.md — not the reports directory. It returns nil (not error) for missing .hal.
  - Files not matching prd-*.md pattern (like notes.md, prd-foo.txt) are correctly excluded.
---

## 2026-02-05 - T-008
- Added TestParseAnalysisResponse with 6 table-driven test cases in analyze_test.go
- Tests: valid JSON, code-fenced JSON, missing priorityItem, missing branchName, no JSON, malformed JSON
- Files changed: internal/compound/analyze_test.go
- **Learnings for future iterations:**
  - parseAnalysisResponse validates 3 required fields: priorityItem, description, branchName.
  - JSON extraction finds first `{` and last `}` — works with code fences but could be fragile with nested objects in surrounding text.
---

## 2026-02-05 - T-009
- Added TestRunInit with 3 subtests in cmd/init_test.go
- Tests: reports dir and .gitkeep created, config.yaml matches template, second run preserves custom config
- Files changed: cmd/init_test.go
- **Learnings for future iterations:**
  - runInit uses relative paths (.hal, .) so tests must os.Chdir to a temp directory. Always save/restore original dir with t.Cleanup.
  - runInit accepts (cmd *cobra.Command, args []string) but works fine with nil for both in tests.
  - skills.InstallSkills and skills.LinkAllEngines run as part of runInit — they create .hal/skills/ and .claude/skills/ symlinks.
---

## 2026-02-05 - T-010
- Ran make test (all pass), make vet (zero warnings), verified compilation
- All new tests run without integration tag; existing tests unaffected
- Files changed: none (verification-only story)
- **Learnings for future iterations:**
  - Full test suite includes cmd/, internal/compound/, internal/engine/, internal/prd/, internal/skills/ — all pass.
  - pipeline_test.go is integration-tagged and excluded from `make test` but still compiles.
---

